var App=Backbone.View.extend({el:$("#main"),count:$("#count"),events:{"click #cards":"get_cards","click #logo":"start_play","click .count":"change_count","click #start-game":"start_play","click #candy":"candy","click #reset-count":"reset_count","click #settings":"open_settings"},initialize:function(){var a=this;if(_.bindAll(this,"render"),a.settings={count:!0,sound:!0,draw:120,show:60,say:60,commands:[]},void 0!=$.cookie("Activity")){var b=JSON.parse($.cookie("Activity"));$.each(b,function(b,c){switch(b){case"commands":break;default:a.settings[b]=c}})}this.render()},get_cards:function(){new CardListView},start_play:function(){new PlayView},open_settings:function(){new Settings},change_count:function(a){if($(a.target).hasClass("count"))$(".count > span").is(":visible")||($(".count > span").show(),setTimeout(function(){$(".count > span").hide()},1e4));else{var b=parseInt($(a.target).parent().find("font").html()),c=$(a.currentTarget).data("id");switch($(a.target).attr("class")){case"minus":b-1>-1&&($(a.target).parent().find("font").html(b-=1),App.settings.commands[c].set("count",b,{silent:!0}));break;case"plus":$(a.target).parent().find("font").html(b+=1),App.settings.commands[c].set("count",b,{silent:!0})}App.set_cookie()}},set_cookie:function(){var a=JSON.stringify(App.settings);$.cookie("Activity",a,{raw:!0,json:!0})},candy:function(){var a=this,b=window.location.href;$.ajax({url:b+"db/index.php",data:{action:"candy",agent:navigator.userAgent,platform:navigator.platform,time:new Date},type:"post",success:function(b){var c=$.parseJSON(b)[0];$("#candy").html("Спасибо, теперь у нас "+c.count+" "+a.declOfNum(parseInt(c.count),["конфета","конфеты","конфет"])),$("#candy").removeClass("btn-primary").addClass("btn-success")}})},update_commands:function(a){var b=this;$(".count-items").html(""),$.get("js/templates/count-item.html",function(a){var c=_.template(a);$.each(b.settings.commands,function(a,b){$(".count-items").append(c({name:b.get("name"),count:b.get("count"),i:a}))})}),b.settings.commands.length>2?$(".count-items").addClass("command3"):$(".count-items").removeClass("command3"),App.set_cookie()},declOfNum:function(a,b){var c=[2,0,1,1,1,2];return b[a%100>4&&a%100<20?2:c[a%10<5?a%10:5]]},reset_count:function(){window.confirm("Обнулить счет?")&&$.each(App.settings.commands,function(a,b){b.set("count",0)})},render:function(){var a=this;$.get("js/templates/count.html",function(b){if(void 0!=$.cookie("Activity")){var c=JSON.parse($.cookie("Activity"));$.each(c.commands,function(b,c){a.settings.commands.push(new Count({name:c.name,count:c.count,id:b}))})}else a.settings.commands.push(new Count({name:"Котята-утята",count:0,id:0})),a.settings.commands.push(new Count({name:"Мальчики-зайчики",count:0,id:1})),App.set_cookie();$(a.count).html(b),a.update_commands()})}}),App=new App,Count=Backbone.Model.extend({defaults:{name:"Command",count:0},initialize:function(){this.on("change",this.change,this)},change:function(a){var b=Object.keys(a.changed)[0];switch(b){case"count":var c=a.attributes.id;$($("font.count")[c]).html(a.changed.count)}App.set_cookie()}}),Card=Backbone.View.extend({el:$("#play-block"),template:"card",progress:{},params:"card-params",next:"get-next",run:!1,word:"",interval_status:1,current:{},events:{},initialize:function(){_.bindAll(this,"render"),this.render()},destroy:function(){$(this.el).html("")},add_point:function(a){var b=$(a.currentTarget).data("cnt"),c=$(a.currentTarget).data("command");App.settings.commands[c].set("count",b+=1),$(".card-body > nav").html('<button type="button" class="btn btn-info" id="get-other" data-next="true">Выбрать следующую</button>'),App.set_cookie()},start:function(){console.log("[Card] start");var a=this;$("#close-play").hide(),$("#word").html(a.encode_word($("#word").html())),$("#word").addClass("encoded"),$.get("js/templates/progress.html",function(b){$(".card-body > nav").html(b);var c=1;a.progress=setInterval(function(){a.interval(c),c++},1e3),a.run=!0})},stop:function(){var a=this;a.run?(clearInterval(a.progress),a.run=!1,$(".progress .progress-bar").addClass("progress-bar-warning"),$(".progress-buttons").show()):(a.progress=setInterval(function(){a.interval(a.interval_status),a.interval_status++},1e3),a.run=!0,$(".progress .progress-bar").removeClass("progress-bar-warning"),$(".progress-buttons").hide())},interval:function(a){var b=this,c=App.settings[this.current],d=Math.floor(80*c/100);if(b.interval_status=a,a>c){try{App.settings.sound&&$("#beep")[0].play()}catch(e){console.error("[E] Error on play audio: ",e)}clearInterval(b.progress),$("#close-play").show(),$.get("js/templates/"+b.next+".html",function(a){var b=_.template(a);$(".card-body > nav").html(""),$.each(App.settings.commands,function(a,c){$(".card-body > nav").append(b({name:c.get("name"),count:c.get("count"),i:a}))}),$(".card-body > nav").append('<div class="no-one"><button type="button" id="get-other" class="btn btn-default btn-xs non-command" data-next="true">Выбрать другую карточку</button></div>')})}a==d&&$(".progress .progress-bar").addClass("progress-bar-danger").removeClass("progress-bar-success"),$(".progress .progress-bar").css("width",100*a/c+"%").attr("aria-valuenow",a)},show_count:function(){var a=this;a.stop(),clearInterval(a.progress),$("#close-play").show(),$.get("js/templates/"+a.next+".html",function(a){var b=_.template(a);$(".card-body > nav").html(""),$.each(App.settings.commands,function(a,c){$(".card-body > nav").append(b({name:c.get("name"),count:c.get("count"),i:a}))}),$(".card-body > nav").append('<div class="no-one"><button type="button" id="get-other" class="btn btn-default btn-xs non-command" data-next="true">Выбрать другую карточку</button></div>')})},get_card:function(a){var b=this,c=window.location.href;return $("#close-play").show(),$.ajax({url:c+"db/index.php",data:{action:"get_card"},type:"post",success:function(c){var d=$.parseJSON(c)[0];$("#card-id").html(d.id),$("#word").html(d.word),$("#word").removeClass("encoded"),b.word=d.word,a&&$.get("js/templates/card-buttons.html",function(a){$(".card-body > nav").html(a)}),$.get("js/templates/"+b.params+".html",function(a){var c=_.template(a),d=Math.floor(3*Math.random())+1,e=[0,0,0];switch(e[Math.floor(3*Math.random())+1-1]=1,$(".parameters").html(c({common:1==d?1:0,draw:e[0],say:e[1],show:e[2]})),e.indexOf(1)){case 0:b.current="draw";break;case 1:b.current="say";break;case 2:b.current="show"}})}}),!1},render:function(a){var b=this;return b.el=$("#play-block"),$.get("js/templates/"+b.template+".html",function(a){$(b.el).html(a),b.get_card(!1)}),!1},encode_word:function(a){var b=[];return $.each(a.split(""),function(a,c){/[\wа-я]+/gi.test(c)?b.push("*"):b.push(c)}),b.join("")},decode_word:function(a){var b=this;a?($("#word").html(b.word),$("#word").removeClass("encoded")):($("#word").html(b.encode_word($("#word").html())),$("#word").addClass("encoded"))}}),CardListView=Backbone.View.extend({el:$("#card-list"),template:"cards-block",list_template:"cards-list",list_template_content:"cards-list-content",autocomplete:[],events:{"click #close-cards":"destroy","click #add-card":"addCard","click .list":"edit_card","click #cancel":"cancel_edit","click #save":"save_edit","click #delete":"delete_card","focus #new-word":"focus_word","keyup #new-word":"enter_word"},initialize:function(){_.bindAll(this,"render"),$("#new-word").on("change",this.input_word,this),this.render()},destroy:function(){$(this.el).html("")},edit_card:function(a){a.preventDefault(),a.stopImmediatePropagation();var b=window.location.href,c=$(a.currentTarget).data("id");return $.ajax({url:b+"db/index.php",data:{action:"get_card_by_id",id:c},type:"post",success:function(a){var b=$.parseJSON(a)[0];$.get("js/templates/edit-modal.html",function(a){var c=_.template(a);$("#modal").html(c({id:b.id,word:b.word,draw:b.draw,say:b.say,show:b.show}))})}}),!1},save_edit:function(a){a.preventDefault(),a.stopImmediatePropagation();var b=this,c=window.location.href,d=$(a.currentTarget).data("id"),e=$(".word-input").val(),f=$(".modale [name=draw]").is(":checked")?1:0,g=$(".modale [name=say]").is(":checked")?1:0,h=$(".modale [name=show]").is(":checked")?1:0;return 0!=e.length&&$(".modale [type=checkbox]").is(":checked")&&$.ajax({url:c+"db/index.php",data:{action:"edit_card",id:d,word:e,draw:f,say:g,show:h},type:"post",success:function(a){var c=$.parseJSON(a);$("#modal").html(""),$.get("js/templates/"+b.list_template_content+".html",function(a){var b=_.template(a),d=$(".list[data-id="+c.id+"]");d.html(b({word:c.word,draw:c.draw,say:c.say,show:c.show}))})}}),!1},cancel_edit:function(){$("#modal").html("")},delete_card:function(a){a.preventDefault(),a.stopImmediatePropagation();var b=window.location.href,c=$(a.currentTarget).data("id");return window.confirm("Удалить карточку?")&&$.ajax({url:b+"db/index.php",data:{action:"delete_card",id:c},type:"post",success:function(a){var b=$.parseJSON(a);$("#modal").html(""),$(".list[data-id="+b.id+"]")[0].remove()}}),!1},addCard:function(a){a.preventDefault(),a.stopImmediatePropagation();var b=this,c=window.location.href,d=$("#card-form").serializeArray();return 0!=d[0].value.length&&$("#card-form [type=checkbox]").is(":checked")&&($("#cards-count").html('<img src="img/loading.gif"/>'),$.ajax({url:c+"db/index.php",data:{action:"add_card",word:$("#card-form [name=word]").val(),draw:$("#card-form [name=draw]").is(":checked")?1:0,say:$("#card-form [name=say]").is(":checked")?1:0,show:$("#card-form [name=show]").is(":checked")?1:0},type:"post",success:function(a){var c=$.parseJSON(a);$("#cards-count").html(c.count),$("#card-form")[0].reset(),$.get("js/templates/"+b.list_template+".html",function(a){var b=_.template(a);$("#card-listing > ul").prepend(b({id:c.id,word:c.word,draw:c.draw,say:c.say,show:c.show}))})}})),!1},focus_word:function(a){a.preventDefault(),a.stopImmediatePropagation();var b=this,c=window.location.href;return $.ajax({url:c+"db/index.php",data:{action:"get_cards"},type:"post",success:function(a){var c=$.parseJSON(a);b.autocomplete=[],$.each(c,function(a,c){b.autocomplete.push(c.word)})}}),!1},enter_word:function(a){a.preventDefault(),a.stopImmediatePropagation();var b=this,c=$(a.currentTarget).val(),d=[];return $("#autocomplete").html(""),c.length>2&&($.each(b.autocomplete,function(a,b){b.toLowerCase().match(c.toLowerCase())&&d.push(b)}),d.length>0&&$("#autocomplete").html("<ul></ul>"),$.each(d,function(a,b){$("#autocomplete ul").append("<li>"+b+"</li>")})),!1},render:function(){var a=this,b=window.location.href;$.get("js/templates/"+a.template+".html",function(c){$(a.el).html(c),$.ajax({url:b+"db/index.php",data:{action:"get_cards"},type:"post",success:function(b){var c=$.parseJSON(b);$("#cards-count").html(c.length),$("#card-listing").html("<ul></ul>"),$.get("js/templates/"+a.list_template+".html",function(a){var b=_.template(a);$.each(c.reverse(),function(a){$("#card-listing > ul").append(b({id:c[a].id,word:c[a].word,draw:c[a].draw,say:c[a].say,show:c[a].show}))})})}})})}}),PlayView=Backbone.View.extend({el:$("#play"),viewport:{},template:"play-block",card:{},events:{"click #close-play":"destroy","click #start":"startPlay","click img.cards":"startPlay","click #get-other":"get_card","click #play":"start","click #point":"add_point","click #word":"decode_word","click .progress":"stop","click .progress-buttons .btn":"get_card","click #win-btn":"show_count"},initialize:function(){_.bindAll(this,"render"),this.render()},get_card:function(a){$(a.currentTarget).data("next")?this.card.get_card(!0):this.card.get_card(!1)},add_point:function(a){this.card.add_point(a)},start:function(){this.card.start()},stop:function(){this.card.stop()},show_count:function(){this.card.show_count()},decode_word:function(a){this.card.decode_word($(a.currentTarget).hasClass("encoded"))},destroy:function(){$(this.el).html("")},startPlay:function(a){return a.preventDefault(),a.stopImmediatePropagation(),$(this.viewport).html('<img class="loading" src="img/load.gif" />'),this.card=new Card,!1},render:function(){var a=this;window.location.href;$.get("js/templates/"+a.template+".html",function(b){$(a.el).html(b),a.viewport=$("#play-block")})}}),Settings=Backbone.View.extend({el:$("#settings-block"),template:"settings",command:"command-name",events:{"click #close-settings":"destroy","change #show-count":"change_show","blur .command-name":"change_name","click #add-command":"add_command","change #play-sound":"change_sound"},initialize:function(){_.bindAll(this,"render"),this.render()},change_show:function(){App.settings.count=$("#show-count").prop("checked"),App.set_cookie()},change_sound:function(){App.settings.sound=$("#play-sound").prop("checked"),App.set_cookie()},change_name:function(a){var b=$(a.currentTarget).data("id"),c=$(a.target).val();c.length>=2&&(App.settings.commands[b].set("name",c),$("#command"+b).html($(a.target).val()))},add_command:function(a){if(a.preventDefault(),a.stopImmediatePropagation(),App.settings.commands.length<3){var b=new Count({name:"Новая команда",count:0,id:2});App.settings.commands.push(b),$.get("js/templates/"+this.command+".html",function(a){var c=_.template(a);$("#commands").append(c({i:2,id:b.get("id"),name:b.get("name")}))}),$("#add-command").html("Удалить команду")}else App.settings.commands.splice(2,1),$("#commands > .input-group:nth-child(3)").remove(),$("#add-command").html("Добавить команду");App.update_commands()},destroy:function(){$(this.el).html("")},render:function(){var a=this;window.location.href;if(void 0!=$.cookie("Activity")){var b=JSON.parse($.cookie("Activity"));App.settings.say=b.say,App.settings.show=b.show,App.settings.draw=b.draw,App.settings.sound=b.sound}$.get("js/templates/"+a.template+".html",function(b){$(a.el).html(b),$("#show-count").prop("checked",App.settings.count),$("#play-sound").prop("checked",App.settings.sound),$("#say-slide").noUiSlider({start:App.settings.say,step:1,range:{min:10,max:120}}),$("#show-slide").noUiSlider({start:App.settings.show,step:1,range:{min:10,max:120}}),$("#draw-slide").noUiSlider({start:App.settings.draw,step:1,range:{min:10,max:120}}),$(".ui-slide").on({change:function(a,b){var c=Math.floor(b),d=a.target.id.split("-")[0];App.settings[d]=c,$("#"+d+"-time > i").html(c),App.set_cookie()}}),$("#say-time > i").html(App.settings.say),$("#draw-time > i").html(App.settings.draw),$("#show-time > i").html(App.settings.show),$.get("js/templates/"+a.command+".html",function(a){var b=_.template(a);$.each(App.settings.commands,function(a,c){$("#commands").append(b({i:a,id:c.get("id"),name:c.get("name")}))})}),App.settings.commands.length>2?$("#add-command").html("Удалить команду"):$("#add-command").html("Добавить команду")})}});